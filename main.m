% main.m
% Run a simple BlueBoat waypoint-following simulation and plot results.
% Also simulates a dock-mounted RADAR at world (0,0), generating bearing+range
% measurements (with range-dependent bias/uncertainty) for each boat.
%
% Assumes these are on the MATLAB path:
%   - src/ (via setup_path)

clear; clc; close all;

%% --- Adding folder to path ---
setup_path();

%% =======================================================================
%  SCENARIO / WAYPOINTS (meters in local frame)
%  =======================================================================

boat1_waypoints_m = [
    0, 50;
    % -40, 70;
];

boat2_waypoints_m = [
    0, 100;
    % 20, 50
];

boat3_waypoints_m = [
    0, 150;
    % -50, -20
];

waypoint_arr = {boat1_waypoints_m, boat2_waypoints_m, boat3_waypoints_m};
simulation_total_time_sec = 440;   % [s]
simulation_dt_sec         = 0.1;   % [s]

%% =======================================================================
%  BOAT PARAMETERS
%  =======================================================================

boat1 = BlueBoat( ...
    "name", "BlueBoat-1", ...
    "dt", simulation_dt_sec, ...
    "x0", boat1_waypoints_m(1,1), "y0", boat1_waypoints_m(1,2), "theta0", 0.0, ...
    "nominal_speed", 1.2, ...
    "yaw_rate_max", 0.6, ...
    "wp_accept_radius", 1.5, ...
    "heading_kp", 1.6, ...
    "slow_down_radius", 6.0, ...
    "gps_period", 1.0, ...
    "heading_period", 0.2, ...
    "gps_sigma_xy", 0.8, ...
    "heading_sigma", deg2rad(3), ...
    "odom_sigma_v", 0.15, ...
    "odom_sigma_w", 0.05, ...
    "bias_v", 0.00, ...
    "bias_w", 0.00, ...
    "rng_seed", 1);

boat2 = BlueBoat( ...
    "name", "BlueBoat-2", ...
    "dt", simulation_dt_sec, ...
    "x0", boat2_waypoints_m(1,1), ...
    "y0", boat2_waypoints_m(1,2), ...
    "theta0", deg2rad(10), ...
    "nominal_speed", 1.15, ...
    "yaw_rate_max", 0.6, ...
    "wp_accept_radius", 1.5, ...
    "heading_kp", 1.6, ...
    "slow_down_radius", 6.0, ...
    "gps_period", 1.0, ...
    "heading_period", 0.2, ...
    "gps_sigma_xy", 0.8, ...
    "heading_sigma", deg2rad(90), ...
    "odom_sigma_v", 0.15, ...
    "odom_sigma_w", 0.05, ...
    "bias_v", 0.00, ...
    "bias_w", 0.00, ...
    "rng_seed", 2);


boat3 = BlueBoat( ...
    "name", "BlueBoat-3", ...
    "dt", simulation_dt_sec, ...
    "x0", boat3_waypoints_m(1,1), ...
    "y0", boat3_waypoints_m(1,2), ...
    "theta0", deg2rad(10), ...
    "nominal_speed", 1.15, ...
    "yaw_rate_max", 0.6, ...
    "wp_accept_radius", 1.5, ...
    "heading_kp", 1.6, ...
    "slow_down_radius", 6.0, ...
    "gps_period", 1.0, ...
    "heading_period", 0.2, ...
    "gps_sigma_xy", 0.8, ...
    "heading_sigma", deg2rad(90), ...
    "odom_sigma_v", 0.15, ...
    "odom_sigma_w", 0.05, ...
    "bias_v", 0.00, ...
    "bias_w", 0.00, ...
    "rng_seed", 3);

boat_arr = [boat1, boat2, boat3];

%% =======================================================================
%  RADAR SETUP + SOLVER CONFIG
%  =======================================================================

dock_radar_pose_world = Pose2(0.0, 0.0, 0.0);
radar_mount_in_dock_frame = Pose2(0.0, 0.0, 0.0);
radar_pose_world = dock_radar_pose_world * radar_mount_in_dock_frame;

bias_model = QuadraticBiasModel();
variance_model = LinearSigmaVarianceModel();

true_bias_params = [0.5; 0.2; 0.05; deg2rad(0.2); deg2rad(0.001); deg2rad(0.0001)];
true_variance_params = [0.8; 0.004; deg2rad(0.6); deg2rad(0.01)];

variance_options = struct( ...
    "sigma_floor_range_m", 1e-4, ...
    "sigma_floor_bearing_rad", 1e-6, ...
    "variance_floor_range_m2", 0.0, ...
    "variance_floor_bearing_rad2", 0.0, ...
    "num_sigma_bins", 30);

true_radar_model = ParametricRadarSensorModel( ...
    bias_model, variance_model, ...
    "bias_parameters", true_bias_params, ...
    "variance_parameters", true_variance_params, ...
    "enable_noise", true, ...
    "variance_options", variance_options, ...
    "range_min_m", 0.0, ...
    "range_max_m", 1.0e4);

prototype_radar_model = ParametricRadarSensorModel( ...
    bias_model, variance_model, ...
    "bias_parameters", [0.01; 0.01; 0.01; 0.01; 0.01; 0.01], ...
    "variance_parameters", [1.0; 0.0; deg2rad(1.0); 0.0], ...
    "enable_noise", false, ...
    "variance_options", variance_options, ...
    "range_min_m", 0.0, ...
    "range_max_m", 1.0e4);

solver = SensorModelSolver( ...
    "bias_model", bias_model, ...
    "variance_model", variance_model, ...
    "min_predicted_range_m", 1.0, ...
    "bearing_wrap_margin_rad", deg2rad(0.5), ...
    "display", "final");

fit_using_estimated_poses = false;

experiment = BlueBoatExperiment( ...
    "boats", boat_arr, ...
    "waypoints", waypoint_arr, ...
    "simulation_total_time_sec", simulation_total_time_sec, ...
    "radar_pose_world", radar_pose_world, ...
    "true_radar_model", true_radar_model, ...
    "prototype_radar_model", prototype_radar_model, ...
    "solver", solver, ...
    "fit_using_estimated_poses", fit_using_estimated_poses);

results = experiment.run();

output_context = struct();
output_context.boats = boat_arr;
output_context.waypoints = waypoint_arr;
output_context.true_radar_model = true_radar_model;
output_context.prototype_radar_model = prototype_radar_model;
output_context.bias_model = bias_model;
output_context.variance_model = variance_model;
output_context.radar_pose_world = radar_pose_world;
output_context.solver = solver;
output_context.simulation = struct( ...
    "total_time_sec", simulation_total_time_sec, ...
    "dt_sec", simulation_dt_sec);

output_options = struct( ...
    "plots", struct( ...
        "trajectories_true", true, ...
        "trajectories_estimated", true, ...
        "covariance_ellipses", true, ...
        "sensor_model_bias_sigma", true, ...
        "radar_detections", true, ...
        "radar_residuals", true), ...
    "prints", struct( ...
        "trajectory_rmse", false, ...
        "radar_rmse", false, ...
        "sensor_model_theta", true, ...
        "prototype_vs_fitted", true, ...
        "sensor_model_functions", true), ...
    "output", struct( ...
        "enabled", true, ...
        "directory", fullfile("outputs", "run_" + string(datestr(now, "yyyy-mm-dd_HHMMSS"))), ...
        "save_plots", true, ...
        "save_parameters", true, ...
        "save_prints", true, ...
        "save_summary", true));

display_experiment_results(results, output_context, output_options);
